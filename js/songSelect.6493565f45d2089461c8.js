(()=>{"use strict";var e={};e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{var t;e.g.importScripts&&(t=e.g.location+"");var o=e.g.document;if(!t&&o&&(o.currentScript&&"SCRIPT"===o.currentScript.tagName.toUpperCase()&&(t=o.currentScript.src),!t)){var n=o.getElementsByTagName("script");if(n.length)for(var r=n.length-1;r>-1&&(!t||!/^http(s?):/.test(t));)t=n[r--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),e.p=t+"../"})();const t={ez:0,hd:1,in:2,at:3},o=e.p+"assets/selectSongItem.7cc8.mp3";function n(){return{createDB:function(e,t,o){return new Promise(function(n,r){const c=indexedDB.open(e);c.onerror=e=>{r({result:"failed",e,request:c})},c.onupgradeneeded=r=>{const c=r.target.result,i=c.createObjectStore(e,{keyPath:t});i.createIndex(t,t,{unique:!0}),o.forEach(e=>{i.createIndex(e,e,{unique:!1})}),n({result:"success",database:c,objectStore:i})}})},openDB:function(e){return new Promise(function(t,o){const n=indexedDB.open(e);n.onerror=e=>{console.error(e),o({result:"failed",e,request:n})},n.onsuccess=r=>{if(!r.target.result.objectStoreNames.contains(e))return r.target.result.close(),indexedDB.deleteDatabase(e),void o({result:"failed",e:r,request:n});const c=r.target.result;var i=c.transaction([e],"readwrite").objectStore(e);t({result:"success",database:c,objectStore:i})}})},readAllKeys:function(e){return new Promise(t=>{const o=e.getAllKeys();o.onsuccess=function(n){const r=n.target.result,c=[];r.forEach((n,i)=>{e.get(n).onsuccess=function(n){c.push(n.target.result),i==r.length-1&&t({result:"success",data:c,objectStore:e,request:o,e:n})}})}})},readKey:function(e,t){return new Promise((o,n)=>{var r=e.get(t);r.onerror=t=>{n({result:"failed",objectStore:e,request:r,e:t})},r.onsuccess=t=>{o(r.result),o({result:"success",value:r.result,objectStore:e,request:r,e:t})}})},updateKey:function(e,t){return new Promise((o,n)=>{var r=e.put(t);r.onsuccess=function(){o({result:"success",objectStore:e,request:r})},r.onerror=function(){n({result:"failed",objectStore:e,request:r})}})},createKey:function(e,t){return new Promise(function(o,n){var r=e.add(t);r.onsuccess=function(){o({result:"success",objectStore:e,request:r})},r.onerror=function(){n({result:"failed",objectStore:e,request:r})}})}}}const r=window.location.hostname.includes("cf")?"https://cf.charts.phicm.focalors.ltd":window.location.hostname.includes("vercel")?"https://vercel.charts.phicm.focalors.ltd":"https://charts.phicm.focalors.ltd";function c(e,o,n,{level:r,onClick:c}){const i=document.createElement("div");i.classList.add("songItemContainer");const s=function(e,t){const o=document.createElement("div");return o.classList.add("songItem"),o.setAttribute("data-artist",e.artist),o.setAttribute("data-codename",t),o.innerText=e.name,o}(o,n),a=function(e,t="ez"){const o=document.createElement("div");return o.classList.add("level"),n(t),{element:o,switchLevel:n};function n(t){o.classList.remove("ez","hd","in","at"),o.classList.add(t),o.setAttribute("data-level",Math.floor(e[t+"Ranking"]||e.ezRanking||e.hdRanking||e.inRanking||e.atRanking||0))}}(o,r);return i.appendChild(s),i.appendChild(a.element),i.addEventListener("click",()=>c(e)),{element:i,songMeta:o,codename:n,select:()=>{s.classList.add("selected"),i.classList.add("selected");for(const e in t)document.querySelector(`div.levelItem.${e}`).classList.remove("disabled"),null==o["chart"+e.toUpperCase()]&&(document.querySelector(`div.levelItem.${e}`).classList.add("disabled"),document.querySelector(`div.levelItem.${e}`).classList.remove("selected")),document.querySelector(`div.levelItem.${e}`).setAttribute("data-level",Math.floor(o[e+"Ranking"]||o.ezRanking||o.hdRanking||o.inRanking||o.atRanking||0))},unSelect:()=>{s.classList.remove("selected"),i.classList.remove("selected")},switchLevel:a.switchLevel}}const i=e.p+"assets/Start.8240.mp3",s=function({defaultLevel:e="ez"}){const i=document.createElement("div");i.id="songList",i.classList.add("songList");const s=[];let a,l=e;return{element:i,items:s,createSong:function(e,t,o){const n=new c(s.length,t,o,{onClick:d,level:l});i.appendChild(n.element),s[e]=n},switchSong:d,switchLevel:u,setOrder:function(e){switch(e){case"level":m((e,t)=>e.songMeta[`${l}Ranking`]<t.songMeta[`${l}Ranking`]?1:-1);break;case"name":m((e,t)=>e.songMeta.name>t.songMeta.name?1:-1);break;default:s.forEach(({element:e})=>e.style.order="")}}};function d(e){if(e===a)return;document.querySelector("#loadingBar").classList.remove("hidden"),fetch(o).then(e=>e.arrayBuffer()).then(e=>{const t=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext);t.decodeAudioData(e,function(e){var o=t.createBufferSource();o.buffer=e,o.loop=!1,o.connect(t.destination),o.start(0)})}),n().openDB("PhiCommunityPlayResults").then(t=>{n().readKey(t.objectStore,window.songMetaList[e].codename+"-"+l).then(e=>{const t=e||{score:0,accuracy:0};document.querySelector("#rightArea > div.detailBar.unplayed > div.score").innerText=Math.round(t.score).toString().padStart(7,"0"),document.querySelector("#rightArea > div.detailBar.unplayed > div.score").setAttribute("data-acc",(100*t.accuracy).toFixed(2)+"%"),document.querySelector("#rightArea > div.detailBar.unplayed > div.score").classList.remove("unplayed")})}),void 0!==a&&s[a].unSelect(),i.classList.selected||i.classList.add("selected"),s[e].select(),console.log("Song",e,"Selected");const{songMeta:c,codename:d}=s[e];for(var m=window.levelSelected||["ez"];null==c["chart"+m[0].toUpperCase()];){var w=t[m[0]]+1;4==w&&(w=0);var g=Object.keys(t)[w];console.log("Chart of level",m[0],"is NULL! Switching to next level: ",g),document.querySelector(`div.levelItem.${m[0]}`).classList.add("disabled"),document.querySelector(`div.levelItem.${m[0]}`).classList.remove("selected"),u(g.match(g)),document.querySelector(`div.levelItem.${g}`).classList.add("selected"),document.querySelectorAll("#songList > div.songItemContainer.selected > div.level").forEach(e=>{e.classList.remove(m[0]),e.classList.add(g)}),m=[g]}fetch(`${r}/${d}/${c.illustration}`).then(e=>e.blob()).then(e=>{const t=URL.createObjectURL(e);document.children[0].setAttribute("style",`--background: url(${t});`),document.querySelector("img.illustration").src=t}).catch(e=>{console.error("获取曲绘失败!",`url: ${r}/${d}/${c.illustration}`,e)}),fetch(`${r}/${d}/${c.musicFile}`).then(e=>e.blob()).then(e=>{const t=URL.createObjectURL(e);try{window.playSongXHRObj.abort()}catch(e){}fetch(t).then(e=>e.arrayBuffer()).then(e=>{const t=window.slicesAudioContext.createGain();window.slicesAudioContext.decodeAudioData(e,function(e){try{window.sliceAudioContextSource.stop()}catch(e){}window.sliceAudioContextSource=window.slicesAudioContext.createBufferSource(),window.sliceAudioContextSource.buffer=e,window.sliceAudioContextSource.connect(t),t.connect(window.slicesAudioContext.destination),window.sliceAudioContextSource.start(0,c.sliceAudioStart),t.gain.setValueAtTime(.01,window.slicesAudioContext.currentTime),t.gain.linearRampToValueAtTime(1,window.slicesAudioContext.currentTime+1),clearInterval(window.sliceAudioInterval),window.sliceAudioInterval=setInterval(()=>{t.gain.linearRampToValueAtTime(.01,window.slicesAudioContext.currentTime+1),setTimeout(()=>{window.sliceAudioContextSource.stop(),window.sliceAudioContextSource=window.slicesAudioContext.createBufferSource(),window.sliceAudioContextSource.buffer=e,window.sliceAudioContextSource.connect(t),window.sliceAudioContextSource.start(0,c.sliceAudioStart),t.gain.linearRampToValueAtTime(1,window.slicesAudioContext.currentTime+1)},500)},15e3)}),document.querySelector("#loadingBar").classList.add("hidden")})}).catch(e=>{console.error("获取歌曲失败!",`url: ${r}/${d}/${c.musicFile}`,e)}),a=e}function u(e){if(l===e)return;window.levelSelected=e,s.forEach(({switchLevel:t})=>t(e)),l=e;const t=document.querySelector("div.songItem.selected").getAttribute("data-codename");n().openDB("PhiCommunityPlayResults").then(e=>{n().readKey(e.objectStore,t+"-"+l).then(e=>{const t=e||{score:0,accuracy:0};document.querySelector("#rightArea > div.detailBar.unplayed > div.score").innerText=Math.round(t.score).toString().padStart(7,"0"),document.querySelector("#rightArea > div.detailBar.unplayed > div.score").setAttribute("data-acc",(100*t.accuracy).toFixed(2)+"%"),document.querySelector("#rightArea > div.detailBar.unplayed > div.score").classList.remove("unplayed")})})}function m(e){[...s].sort((t,o)=>e(t,o)).forEach(({element:e},t)=>{e.style.order=t})}}({defaultLevel:"ez"});function a(e){const t=e;try{document.querySelector("div.levelItem.selected").classList.add("fadeOut")}catch(t){}setTimeout(()=>{try{document.querySelector("div.levelItem.selected").classList.remove("selected")}catch(e){}t.target.classList.add("fadeIn"),t.target.classList.add("selected")},300);const o=t.target.classList.toString();s.switchLevel(o.match(/ez|hd|in|at/));const n=document.querySelectorAll("div.levelItem.fadeIn");for(let e=0;e<n.length;e++)n[e].classList.remove("fadeIn");const r=document.querySelectorAll("div.levelItem.fadeOut");for(let e=0;e<n.length;e++)r[e].classList.remove("fadeOut")}window.addEventListener("DOMContentLoaded",()=>{let e=document.createElement("iframe");e.src="../loadingScreen/index.html",e.classList.add("loadingEmbedFrame"),document.body.appendChild(e);const t=[["default","默认"],["level","难度"],["name","名称"]];document.querySelector("div.settingBtn").addEventListener("click",()=>{location.href="../settings/index.html"}),document.querySelector("div#avatarBar").addEventListener("click",e=>{var t=e.target;null==t.classList.toString().match("avatarBar")&&(t=e.target.parentElement),t.classList.toString().match("expand")?t.classList.remove("expand"):t.classList.add("expand")}),null!=window.localStorage.getItem("playerName")&&(console.log("Setting player name: ",window.localStorage.getItem("playerName")),document.querySelector("div#avatarBar").setAttribute("data-name",window.localStorage.getItem("playerName"))),null!=window.localStorage.getItem("playerAvatar")&&(console.log("Setting player avatar: ",window.localStorage.getItem("playerAvatar")),document.querySelector("div#avatarBar").children[0].setAttribute("style",'--avatar: url("'+window.localStorage.getItem("playerAvatar")+'");')),window.chapterName=new URLSearchParams(new URL(location.href).search).get("c"),window.songCodeNameList=["tutorial","ouroVoros"];const o=JSON.parse(localStorage.getItem("installedCharts"));window.songCodeNameList=null==o?window.songCodeNameList:window.songCodeNameList.concat(o),window.songMetaList=new Array(window.songCodeNameList.length);for(let e=0;e<window.songCodeNameList.length;e++)fetch(encodeURI(r+"/"+window.songCodeNameList[e]+"/meta.json")).then(e=>e.json()).then(t=>{window.songMetaList[e]=t});const n=setInterval(()=>{if(!JSON.stringify(window.songMetaList).includes("null")){const o=s.element;document.getElementsByClassName("leftArea")[0].appendChild(o);for(let e=0;e<window.songMetaList.length;e++)s.createSong(e,window.songMetaList[e],window.songMetaList[e].codename);let r=0;document.querySelector("div.sortMode").innerText=t[0][1],document.querySelector("div.sortMode").addEventListener("click",e=>{r=(r+1)%t.length,s.setOrder(t[r][0]),e.target.innerText=t[r][1]}),window.slicesAudioContext=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext),s.switchSong(0),document.querySelector("#rightArea > div.detailBar > div.levelChooser > div.levelItem.selected").click(),e.remove(),document.querySelector("#rightArea").style.setProperty("--scale",Math.round(window.devicePixelRatio)/3.5),clearInterval(n)}},100)}),document.querySelectorAll("div.levelItem").forEach(e=>e.addEventListener("click",a)),document.querySelector("div#deleteChart").addEventListener("click",()=>{const e=document.querySelector("div.songItem.selected").getAttribute("data-codename"),t=document.querySelector("div.songItem.selected").innerText;if(confirm("是否要删除"+t+"?")){const t=JSON.parse(localStorage.getItem("installedCharts"));if(!t.includes(e))return void alert("不能操作内置曲目");{t.splice(t.indexOf(e)-1,1),localStorage.setItem("installedCharts",JSON.stringify(t));const o=document.querySelector("div.songItemContainer.selected");null==o.nextElementSibling?o.previousElementSibling.click():o.nextElementSibling.click(),o.remove()}}}),document.querySelector("div.playBtn").addEventListener("click",()=>{clearInterval(window.sliceAudioInterval);try{window.sliceAudioContextSource.stop()}catch(e){}document.querySelector("#readyToLoadOverlay").classList.add("go"),fetch(i).then(e=>e.arrayBuffer()).then(e=>{const t=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext);t.decodeAudioData(e,function(e){var o=t.createBufferSource();o.buffer=e,o.loop=!1,o.connect(t.destination),o.start(0)})}),setTimeout(()=>{null==window.slicesAudioContext||window.slicesAudioContext.close(),location.href="../whilePlaying/index.html?play="+document.querySelector("div.songItem.selected").getAttribute("data-codename")+"&l="+window.levelSelected},2e3)})})();